# UPM v0.1.0 Implementation Report — Unified Parameter Model (MSI `.frc` subset, CSV bundles, minimal resolver)

**Date:** 2025-12-16  
**Status:** Implemented + validated via unit tests + workspace demos (full suite green)  
**Primary spec:** [`docs/DevGuides/DevGuide_v0.1.0.md`](docs/DevGuides/DevGuide_v0.1.0.md:1)  
**Baseline:** Fresh repo bootstrap per spec (standalone; no USM dependency)

---

## 1. Executive Summary

UPM v0.1.0 delivers a **standalone, versioned, testable parameter-package workflow** focused on MSI `.frc` forcefield files, supporting:

- **Import** of supported `.frc` sections into canonical tables (Pandas DataFrames).
- **Lossless preservation** of unsupported/unknown `.frc` sections as raw text blobs.
- **Validation** (schema + invariants) for canonical tables.
- **Export** of deterministic `.frc` outputs from canonical tables (both full and “minimal” export from subset tables).
- **Resolver** to select a minimal subset from a Requirements JSON (v0.1 requires only atom types + bond types; missing terms hard-error).
- **Reproducible demos** under `workspaces/` that exercise end-to-end behavior without external dependencies.

This implementation is intentionally independent: it does not require USM, charge models, or any database system.

---

## 2. Problem / Motivation (Why v0.1.0)

Prior workflows frequently treat forcefield parameter files as opaque artifacts, which makes it hard to:
- Validate correctness and invariants.
- Select only the parameter subset needed for a specific system.
- Preserve provenance and avoid accidental data loss on “round-trip” edits.
- Reproduce results across machines and runs.

UPM addresses this by establishing a canonical, validated, deterministic representation with a resolver and a stable bundle format.

---

## 3. Implementation Overview (What changed)

### 3.1 Core data model + canonicalization (`Requirements`, `ResolvedFF`)

**Files:**
- Core model: [`src/upm/core/model.py`](src/upm/core/model.py:1)
- Public exports: [`src/upm/core/__init__.py`](src/upm/core/__init__.py:1), [`src/upm/__init__.py`](src/upm/__init__.py:1)

**Key behaviors (v0.1):**
- Canonicalization utilities exist, including [`canonicalize_bond_key()`](src/upm/core/model.py:36).
- [`Requirements`](src/upm/core/model.py:121) is canonical on construction:
  - stores `atom_types`, `bond_types`, `angle_types`, `dihedral_types` as sorted/deduped tuples
  - validates lengths/types and rejects empty strings
- [`ResolvedFF`](src/upm/core/model.py:171) is the resolver output container for subset tables + provenance fields.

---

### 3.2 Requirements JSON I/O (standalone v0.1)

**Files:**
- Reader: [`src/upm/io/requirements.py`](src/upm/io/requirements.py:1)
- IO exports: [`src/upm/io/__init__.py`](src/upm/io/__init__.py:1)
- Tests: [`tests/test_requirements_io.py`](tests/test_requirements_io.py:1)

**Behavior:**
- Reads the v0.1 Requirements JSON schema per spec and defaults missing arrays to empty.
- Rejects `null` arrays (hard error).
- Canonicalization is enforced by constructing [`Requirements`](src/upm/core/model.py:121).

---

### 3.3 Canonical tables + deterministic normalization

**Files:**
- Schemas + normalizers: [`src/upm/core/tables.py`](src/upm/core/tables.py:1)
- Validators: [`src/upm/core/validate.py`](src/upm/core/validate.py:1)
- Tests: [`tests/test_tables_validation.py`](tests/test_tables_validation.py:1)

**Core behaviors:**
- Tables are represented as `dict[str, pandas.DataFrame]` with canonical names.
- Normalization ensures deterministic sorting and canonicalized keys (e.g., bonds enforce `t1 <= t2`).
- Validation is strict and aggregates violations via `TableValidationError` in [`src/upm/core/validate.py`](src/upm/core/validate.py:1).

---

### 3.4 Bundle format (CSV) + manifest hashing

**Files:**
- Bundle I/O: [`src/upm/bundle/io.py`](src/upm/bundle/io.py:1)
- Manifest hashing: [`src/upm/bundle/manifest.py`](src/upm/bundle/manifest.py:1)
- Tests: [`tests/test_bundle_roundtrip.py`](tests/test_bundle_roundtrip.py:1)

**Behavior:**
- Writes a package folder containing:
  - `manifest.json`
  - `tables/*.csv`
  - `raw/source.frc`
  - `raw/unknown_sections.json`
- Manifest contains sha256 hashes for tables and sources, enabling integrity validation.

---

### 3.5 MSI `.frc` codec (supported subset) + raw preservation

**Files:**
- Codec: [`src/upm/codecs/msi_frc.py`](src/upm/codecs/msi_frc.py:1)
- Tests: [`tests/test_msi_frc_codec.py`](tests/test_msi_frc_codec.py:1)

**Supported import/export sections (v0.1 minimal scope):**
- `#atom_types`
- `#quadratic_bond`
- `#nonbond(12-6)` with required directives:
  - `@type A-B`
  - `@combination geometric`

**Raw preservation:**
- Unsupported sections are captured into an `unknown_sections` mapping and can be written back out during export, preserving content.

**Determinism:**
- Export emits supported sections in a fixed order and uses stable float formatting.

---

### 3.6 CHARMM `.prm` codec stub (explicitly out-of-scope)

**Files:**
- Stub: [`src/upm/codecs/charmm_prm.py`](src/upm/codecs/charmm_prm.py:1)
- Tests: [`tests/test_charmm_prm_stub.py`](tests/test_charmm_prm_stub.py:1)

Behavior: calling the `.prm` codec raises a clear `NotImplementedError` referencing v0.1 scope.

---

### 3.7 Resolver (minimal subset selection) + explicit missing-term errors

**Files:**
- Resolver: [`src/upm/core/resolve.py`](src/upm/core/resolve.py:1)
- Tests: [`tests/test_resolve_minimal_subset.py`](tests/test_resolve_minimal_subset.py:1)

**Behavior:**
- [`resolve_minimal()`](src/upm/core/resolve.py:1) selects subset rows for:
  - `atom_types` by required atom types
  - `bonds` by required bond tuples
- Missing required terms raise deterministic `MissingTermsError` listing missing atom types and/or bond tuples.

---

### 3.8 CLI implementation (Typer)

**Files:**
- Entry: [`src/upm/cli/main.py`](src/upm/cli/main.py:1)
- Commands:
  - [`src/upm/cli/commands/import_frc.py`](src/upm/cli/commands/import_frc.py:1)
  - [`src/upm/cli/commands/validate_pkg.py`](src/upm/cli/commands/validate_pkg.py:1)
  - [`src/upm/cli/commands/export_frc.py`](src/upm/cli/commands/export_frc.py:1)

**Commands supported:**
- `upm import-frc ...` → parse `.frc`, validate, save bundle
- `upm validate ...` → load bundle, validate tables (optional hash validation)
- `upm export-frc ...` → export full or minimal (minimal uses Requirements + resolver)

---

### 3.9 Workspaces (reproducible demos)

**Files:**
- Workspace 00: [`workspaces/00_quickcheck_import_export/run.py`](workspaces/00_quickcheck_import_export/run.py:1)
- Workspace 01: [`workspaces/01_minimal_subset_export/run.py`](workspaces/01_minimal_subset_export/run.py:1), [`workspaces/01_minimal_subset_export/requirements.json`](workspaces/01_minimal_subset_export/requirements.json:1)

**Behavior:**
- Workspace 00 executes import → export(full) → reimport → compare, emitting reports into `outputs/`.
- Workspace 01 resolves a minimal subset and exports `minimal.frc`, verifying correctness via re-import.

---

## 4. Validation & Test Results

### 4.1 Acceptance tests implemented (per spec)

- **AT1 (supported-subset round-trip equality):**  
  [`tests/test_frc_import_export_roundtrip.py`](tests/test_frc_import_export_roundtrip.py:1)

- **AT2 (minimal subset export matches Requirements exactly):**  
  Covered in [`tests/test_resolve_minimal_subset.py`](tests/test_resolve_minimal_subset.py:1)

- **AT3 (missing-term errors explicit and list missing keys):**  
  Covered in [`tests/test_resolve_minimal_subset.py`](tests/test_resolve_minimal_subset.py:1)

### 4.2 Full test suite (green)

Command executed in this environment:
- `pytest -q`

Result:
- `25 passed in 0.44s`

---

## 5. New Coverage Added (Unit/Integration-style)

Notable new test modules:
- Requirements I/O: [`tests/test_requirements_io.py`](tests/test_requirements_io.py:1)
- Table normalization + validation: [`tests/test_tables_validation.py`](tests/test_tables_validation.py:1)
- Bundle roundtrip + manifest hashing: [`tests/test_bundle_roundtrip.py`](tests/test_bundle_roundtrip.py:1)
- `.frc` codec behavior + determinism: [`tests/test_msi_frc_codec.py`](tests/test_msi_frc_codec.py:1)
- `.prm` stub errors: [`tests/test_charmm_prm_stub.py`](tests/test_charmm_prm_stub.py:1)
- Resolver subset + missing-term errors: [`tests/test_resolve_minimal_subset.py`](tests/test_resolve_minimal_subset.py:1)
- Roundtrip acceptance: [`tests/test_frc_import_export_roundtrip.py`](tests/test_frc_import_export_roundtrip.py:1)

---

## 6. Backward Compatibility Guarantees

UPM v0.1.0 is a new standalone package in this repo baseline. Compatibility guarantees implemented are internal and forward-looking:
- Deterministic schemas and manifest hashing support reproducible reruns.
- Unknown `.frc` sections are preserved (avoids losing information on roundtrip).

---

## 7. Known Issues / Warnings Observed

1) Optional parts explicitly deferred by the chosen “minimal acceptance” scope:
- Angles/dihedrals parsing + resolving are not required for acceptance (requirements fields exist but resolver enforces only atom types + bond types).
- `--allow-missing/--force` behavior is not implemented (hard error on missing terms).
- “Toy structure JSON → Requirements” is not implemented.

2) Environment note:
- A `pytest-asyncio` deprecation warning was observed during development; tests remain green.

---

## 8. How to Use (Operational Quickstart)

1) Install:
- `python -m pip install -e ".[dev]"`

2) Run workspace demos:
- `python workspaces/00_quickcheck_import_export/run.py`
- `python workspaces/01_minimal_subset_export/run.py`

3) CLI examples:
- Import a `.frc` into a bundle:
  - `upm import-frc path/to/file.frc --name <pkg-name> --version <pkg-version>`
- Validate a bundle:
  - `upm validate --path packages/<pkg-name>/<pkg-version>`
- Export full `.frc`:
  - `upm export-frc --path packages/<pkg-name>/<pkg-version> --mode full --out outputs/full.frc`
- Export minimal `.frc` from Requirements:
  - `upm export-frc --path packages/<pkg-name>/<pkg-version> --mode minimal --requirements path/to/requirements.json --out outputs/min.frc`

(These flows are also documented in [`README.md`](README.md:1).)

---

## 9. Conclusion

UPM v0.1.0 meets the minimal acceptance target from [`docs/DevGuides/DevGuide_v0.1.0.md`](docs/DevGuides/DevGuide_v0.1.0.md:1) end-to-end:

- canonical models + deterministic tables
- validated bundle format (CSV + manifest hashing)
- `.frc` codec for supported subset with raw preservation
- resolver for minimal subset selection with explicit missing-term errors
- CLI + workspaces + acceptance tests
- full test suite green (`pytest -q`: 25 passed)